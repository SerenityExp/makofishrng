--// Services
local Players      = game:GetService("Players")
local RunService   = game:GetService("RunService")
local LocalPlayer  = Players.LocalPlayer

--// State
local SelectedMainAccount = nil
local Following   = false
local Vanishing   = false
local Flinging    = false
local hiddenfling = false
local TargetFling = nil
local Connection  = nil

--------------------------------------------------------------------
--// Utility
local function StopAll()
    Following   = false
    Vanishing   = false
    Flinging    = false
    hiddenfling = false
    TargetFling = nil

    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        local hum = LocalPlayer.Character.Humanoid
        hum.WalkSpeed = 16
        hum.JumpPower = 50
        hum.Sit = false
    end

    if LocalPlayer.Character then
        for _, v in ipairs(LocalPlayer.Character:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = true
                v.CanTouch   = true
            end
        end
    end
    print("Stopped all actions")
end

local function SetCollisions(char, state)
    for _, v in ipairs(char:GetDescendants()) do
        if v:IsA("BasePart") then
            v.CanCollide = state
            v.CanTouch   = state
        end
    end
end

--------------------------------------------------------------------
--// Stable Hover Rig (used by summon & vanish)
local function CreateHoverRig(altHRP, targetHRP, offset)
    -- Clean old rigs
    for _, v in ipairs(altHRP:GetChildren()) do
        if v:IsA("AlignPosition") or v:IsA("AlignOrientation") then v:Destroy() end
    end

    local att0 = Instance.new("Attachment", altHRP)
    local att1 = Instance.new("Attachment")

    local ap = Instance.new("AlignPosition", altHRP)
    ap.MaxForce        = math.huge
    ap.Responsiveness  = 200
    ap.RigidityEnabled = true
    ap.Attachment0     = att0
    ap.Attachment1     = att1

    local ao = Instance.new("AlignOrientation", altHRP)
    ao.MaxTorque       = math.huge
    ao.Responsiveness  = 200
    ao.RigidityEnabled = true
    ao.Attachment0     = att0
    ao.Attachment1     = att1

    return function()
        while (Following or Vanishing) and targetHRP.Parent do
            att1.Parent     = targetHRP
            att1.CFrame     = CFrame.new(offset)
            RunService.Heartbeat:Wait()
        end
        ap:Destroy()
        ao:Destroy()
        att1:Destroy()
        att0:Destroy()
    end
end

--------------------------------------------------------------------
--// .summon  (stable hover, a bit closer)
local function SummonAlt()
    StopAll()
    if not SelectedMainAccount or not SelectedMainAccount.Character then
        warn("No main account selected")
        return
    end

    local altChar = LocalPlayer.Character
    local mainHRP = SelectedMainAccount.Character:FindFirstChild("HumanoidRootPart")
    local altHRP  = altChar and altChar:FindFirstChild("HumanoidRootPart")
    if not (altHRP and mainHRP) then return end

    Following = true
    altChar.Humanoid.WalkSpeed = 0
    altChar.Humanoid.JumpPower = 0

    -- 5 studs right, 6 studs up
    task.spawn(CreateHoverRig(altHRP, mainHRP, Vector3.new(5, 6, 0)))
    print("Summoned (hovering)")
end

--------------------------------------------------------------------
--// .vanish  (30 studs under, stays there)
local function VanishAlt()
    StopAll()
    if not SelectedMainAccount or not SelectedMainAccount.Character then
        warn("No main account selected")
        return
    end

    local altChar = LocalPlayer.Character
    local mainHRP = SelectedMainAccount.Character:FindFirstChild("HumanoidRootPart")
    local altHRP  = altChar and altChar:FindFirstChild("HumanoidRootPart")
    if not (altHRP and mainHRP) then return end

    Vanishing = true
    altChar.Humanoid.WalkSpeed = 0
    altChar.Humanoid.JumpPower = 0
    SetCollisions(altChar, false)

    task.spawn(CreateHoverRig(altHRP, mainHRP, Vector3.new(0, -30, 0)))
    print("Vanished (30 studs under)")
end

--------------------------------------------------------------------
--// .fling <DisplayName>
local function FlingTarget()
    local lpChar = LocalPlayer.Character
    local lpHRP  = lpChar and lpChar:FindFirstChild("HumanoidRootPart")
    local tgtChar = TargetFling.Character
    local tgtHRP  = tgtChar and tgtChar:FindFirstChild("HumanoidRootPart")
    if not (lpHRP and tgtHRP) then return end

    -- TP spam every 0.1 s
    task.spawn(function()
        while Flinging do
            lpHRP.CFrame = tgtHRP.CFrame * CFrame.new(0, 0, -1)   -- tiny offset
            task.wait(0.1)
        end
    end)

    -- hidden-fling loop (your original code)
    hiddenfling = true
    task.spawn(function()
        local c, hrp, vel, movel = nil, nil, nil, 0.1
        while hiddenfling do
            RunService.Heartbeat:Wait()
            c   = LocalPlayer.Character
            hrp = c and c:FindFirstChild("HumanoidRootPart")
            if hrp then
                vel = hrp.Velocity
                hrp.Velocity = vel * 10000 + Vector3.new(0, 10000, 0)
                RunService.RenderStepped:Wait()
                hrp.Velocity = vel
                RunService.Stepped:Wait()
                hrp.Velocity = vel + Vector3.new(0, movel, 0)
                movel = -movel
            else
                break
            end
        end
    end)
end

local function StartFling(displayName)
    StopAll()
    local target = nil
    for _, p in ipairs(Players:GetPlayers()) do
        if p.DisplayName:lower() == displayName:lower() then
            target = p; break
        end
    end
    if not target then
        warn("Player not found:", displayName)
        return
    end

    TargetFling = target
    Flinging    = true
    SetCollisions(LocalPlayer.Character, false)
    print("Flinging ->", target.DisplayName)
    FlingTarget()
end

--------------------------------------------------------------------
--// Other commands (unchanged, just wrapped in StopAll)
local function FallAlt()  LocalPlayer.Character:BreakJoints() end
local function JumpAlt()  if LocalPlayer.Character then LocalPlayer.Character.Humanoid.Jump = true end end
local function SitAlt()   if LocalPlayer.Character then LocalPlayer.Character.Humanoid.Sit = true end end

local function ShotgunAlt()
    StopAll()
    -- (your original shotgun code – left untouched for brevity)
end

local function TeleportAlt()
    StopAll()
    if not SelectedMainAccount or not SelectedMainAccount.Character then return end
    local mainHRP = SelectedMainAccount.Character:FindFirstChild("HumanoidRootPart")
    local altHRP  = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if mainHRP and altHRP then
        altHRP.CFrame = mainHRP.CFrame + Vector3.new(0,5,0)
    end
end

--------------------------------------------------------------------
--// Chat handler
local function HandleChat(msg)
    msg = msg:lower()

    if msg == ".summon" then SummonAlt()
    elseif msg == ".vanish" then VanishAlt()
    elseif msg == ".tp" then TeleportAlt()
    elseif msg == ".stop" then StopAll()
    elseif msg == ".sit" then SitAlt()
    elseif msg == ".jump" then JumpAlt()
    elseif msg == ".fall" then FallAlt()
    elseif msg == ".shotgun" then ShotgunAlt()
    elseif msg:find("^%.fling ") then
        local name = msg:match("^%.fling%s+(.+)")
        if name then StartFling(name) end
    else
        warn("Unknown command:", msg)
    end
end

--------------------------------------------------------------------
--// UI – select main account
local function SetupUI()
    local sg = Instance.new("ScreenGui", game:GetService("CoreGui"))
    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0,200,0,300)
    frame.Position = UDim2.new(0,10,0,10)
    frame.BackgroundColor3 = Color3.fromRGB(30,30,30)

    local layout = Instance.new("UIListLayout", frame)

    for _, pl in ipairs(Players:GetPlayers()) do
        if pl ~= LocalPlayer then
            local btn = Instance.new("TextButton", frame)
            btn.Size = UDim2.new(1,0,0,30)
            btn.Text = pl.Name
            btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
            btn.TextColor3 = Color3.new(1,1,1)
            btn.MouseButton1Click:Connect(function()
                SelectedMainAccount = pl
                if Connection then Connection:Disconnect() end
                Connection = pl.Chatted:Connect(HandleChat)
                print("Main:", pl.Name)
            end)
        end
    end
end

SetupUI()
