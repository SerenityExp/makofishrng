--[[ ==============================================================
     ALT‑CONTROL SCRIPT – FINAL + .FLOAT & .SHOTGUN RESTORED
     • .summon  → hover (no collision)
     • .vanish  → 30 studs under (no collision)
     • .float   → rise upward under main (no collision)
     • .fling   → TP + fling (collisions ON)
     • .shotgun → move to arm, fire forward, reset
     • .tweak   → spin on ground, faster (collisions ON)
     • .stop    → reset all + restore collisions
   ============================================================== ]]

local Players      = game:GetService("Players")
local RunService   = game:GetService("RunService")
local LocalPlayer  = Players.LocalPlayer

--// STATE ---------------------------------------------------------
local MainAccount   = nil
local IsSummoning   = false
local IsVanishing   = false
local IsFloating    = false
local IsFlinging    = false
local IsTweaking    = false
local FlingTarget   = nil
local ChatConn      = nil
local TweakSpeed    = 0

--// UTILS ---------------------------------------------------------
local function StopEverything()
    IsSummoning = false; IsVanishing = false; IsFloating = false
    IsFlinging = false; IsTweaking = false
    FlingTarget = nil; TweakSpeed = 0

    local char = LocalPlayer.Character
    if char and char:FindFirstChildOfClass("Humanoid") then
        local hum = char.Humanoid
        hum.WalkSpeed = 16
        hum.JumpPower = 50
        hum.Sit = false
    end

    if char then
        for _, v in ipairs(char:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = true
                v.CanTouch   = true
            end
        end
    end
    print("[ALT] Stopped all actions – collisions RESTORED")
end

local function NoCollide(char, bool)
    for _, v in ipairs(char:GetDescendants()) do
        if v:IsA("BasePart") then
            v.CanCollide = bool
            v.CanTouch   = bool
        end
    end
end

--// HOVER RIG (summon, vanish, float) ---------------------------
local function HoverRig(altHRP, targetHRP, offset)
    for _, v in ipairs(altHRP:GetChildren()) do
        if v:IsA("AlignPosition") or v:IsA("AlignOrientation") then v:Destroy() end
    end

    local att0 = Instance.new("Attachment", altHRP)
    local att1 = Instance.new("Attachment")

    local ap = Instance.new("AlignPosition", altHRP)
    ap.MaxForce        = 1/0
    ap.Responsiveness  = 200
    ap.RigidityEnabled = true
    ap.Attachment0     = att0
    ap.Attachment1     = att1

    local ao = Instance.new("AlignOrientation", altHRP)
    ao.MaxTorque       = 1/0
    ao.Responsiveness  = 200
    ao.RigidityEnabled = true
    ao.Attachment0     = att0
    ao.Attachment1     = att1

    return task.spawn(function()
        while (IsSummoning or IsVanishing or IsFloating) and targetHRP and targetHRP.Parent do
            att1.Parent = targetHRP
            att1.CFrame = CFrame.new(offset)
            RunService.Heartbeat:Wait()
        end
        ap:Destroy(); ao:Destroy(); att1:Destroy(); att0:Destroy()
    end)
end

--// .summon -------------------------------------------------------
local function Summon()
    StopEverything()
    if not MainAccount or not MainAccount.Character then warn("[ALT] No main selected"); return end

    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local altHRP  = char:FindFirstChild("HumanoidRootPart")
    local mainHRP = MainAccount.Character:FindFirstChild("HumanoidRootPart")
    if not (altHRP and mainHRP) then return end

    IsSummoning = true
    char.Humanoid.WalkSpeed = 0
    char.Humanoid.JumpPower = 0
    NoCollide(char, false)  -- OFF
    HoverRig(altHRP, mainHRP, Vector3.new(5, 6, 0))
    print("[ALT] Summoned – hovering (no collision)")
end

--// .vanish -------------------------------------------------------
local function Vanish()
    StopEverything()
    if not MainAccount or not MainAccount.Character then warn("[ALT] No main selected"); return end

    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local altHRP  = char:FindFirstChild("HumanoidRootPart")
    local mainHRP = MainAccount.Character:FindFirstChild("HumanoidRootPart")
    if not (altHRP and mainHRP) then return end

    IsVanishing = true
    char.Humanoid.WalkSpeed = 0
    char.Humanoid.JumpPower = 0
    NoCollide(char, false)  -- OFF
    HoverRig(altHRP, mainHRP, Vector3.new(0, -30, 0))
    print("[ALT] Vanished – 30 studs under (no collision)")
end

--// .float --------------------------------------------------------
local function Float()
    StopEverything()
    if not MainAccount or not MainAccount.Character then warn("[ALT] No main selected"); return end

    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local altHRP  = char:FindFirstChild("HumanoidRootPart")
    local mainHRP = MainAccount.Character:FindFirstChild("HumanoidRootPart")
    if not (altHRP and mainHRP) then return end

    IsFloating = true
    char.Humanoid.WalkSpeed = 0
    char.Humanoid.JumpPower = 0
    NoCollide(char, false)  -- OFF

    -- Start under legs
    altHRP.CFrame = mainHRP.CFrame + Vector3.new(0, -3, 0)

    -- Rise continuously
    task.spawn(function()
        local rise = 0
        while IsFloating and altHRP and mainHRP do
            rise = rise + 0.5
            HoverRig(altHRP, mainHRP, Vector3.new(0, rise, 0))  -- dynamic offset
            task.wait(0.1)
        end
    end)

    print("[ALT] Floating – rising upward (no collision)")
end

--// .shotgun ------------------------------------------------------
local function Shotgun()
    StopEverything()
    if not MainAccount or not MainAccount.Character then warn("[ALT] No main selected"); return end

    local AltChar = LocalPlayer.Character
    local MainChar = MainAccount.Character
    if not AltChar or not MainChar then return end

    local MainHRP = MainChar:FindFirstChild("HumanoidRootPart")
    local AltHRP = AltChar:FindFirstChild("HumanoidRootPart")
    local RightArm = MainChar:FindFirstChild("Right Arm") or MainChar:FindFirstChild("RightHand")
    if not MainHRP or not AltHRP or not RightArm then
        warn("[ALT] Shotgun failed: Missing parts")
        return
    end

    print("[ALT] Moving to arm for shotgun...")
    local AlignPos = Instance.new("AlignPosition", AltHRP)
    AlignPos.MaxForce = 100000
    AlignPos.Responsiveness = 100
    AlignPos.Attachment0 = Instance.new("Attachment", AltHRP)
    AlignPos.Attachment1 = Instance.new("Attachment", RightArm)
    task.wait(2)

    print("[ALT] Firing shotgun!")
    AlignPos:Destroy()
    local BodyVelocity = Instance.new("BodyVelocity", AltHRP)
    BodyVelocity.Velocity = MainHRP.CFrame.LookVector * 250
    BodyVelocity.MaxForce = Vector3.new(100000, 100000, 100000)
    task.wait(0.5)
    BodyVelocity:Destroy()
    task.wait(1)
    LocalPlayer.Character:BreakJoints()  -- Reset
end

--// .fling <DisplayName> -----------------------------------------
local function StartFling(displayName)
    StopEverything()
    local target = nil
    for _, p in ipairs(Players:GetPlayers()) do
        if p.DisplayName:lower() == displayName:lower() then target = p; break end
    end
    if not target then warn("[ALT] Player not found:", displayName); return end

    FlingTarget = target
    IsFlinging  = true
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

    task.spawn(function()
        while IsFlinging do
            local lpHRP = char:FindFirstChild("HumanoidRootPart")
            local tgtHRP = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
            if lpHRP and tgtHRP then
                lpHRP.CFrame = tgtHRP.CFrame * CFrame.new(0,0,-1)
            end
            task.wait(0.1)
        end
    end)

    task.spawn(function()
        local c, hrp, vel, movel = nil, nil, nil, 0.1
        while IsFlinging do
            RunService.Heartbeat:Wait()
            c   = LocalPlayer.Character
            hrp = c and c:FindFirstChild("HumanoidRootPart")
            if hrp then
                vel = hrp.Velocity
                hrp.Velocity = vel * 10000 + Vector3.new(0, 10000, 0)
                RunService.RenderStepped:Wait()
                hrp.Velocity = vel
                RunService.Stepped:Wait()
                hrp.Velocity = vel + Vector3.new(0, movel, 0)
                movel = -movel
            else
                break
            end
        end
    end)

    print("[ALT] Flinging ->", target.DisplayName, "(collisions ON)")
end

--// .tweak --------------------------------------------------------
local function Tweak()
    StopEverything()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    IsTweaking = true
    TweakSpeed = 100

    task.spawn(function()
        while IsTweaking do
            if hrp and hrp.Parent then
                local pos = hrp.Position
                hrp.CFrame = CFrame.new(pos.X, pos.Y, pos.Z) * CFrame.Angles(0, math.rad(TweakSpeed), 0)
                TweakSpeed = TweakSpeed + 15
            end
            RunService.Heartbeat:Wait()
        end
    end)

    print("[ALT] Tweak started – spinning faster... (collisions ON)")
end

--// OTHER COMMANDS ------------------------------------------------
local function Teleport()
    StopEverything()
    if not MainAccount or not MainAccount.Character then return end
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local altHRP  = char:FindFirstChild("HumanoidRootPart")
    local mainHRP = MainAccount.Character:FindFirstChild("HumanoidRootPart")
    if altHRP and mainHRP then
        altHRP.CFrame = mainHRP.CFrame + Vector3.new(0,5,0)
        print("[ALT] Teleported")
    end
end

local function Jump()
    StopEverything()
    local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if hum then hum.Jump = true end
end

local function Sit()
    StopEverything()
    local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if hum then hum.Sit = true end
end

local function Fall()
    StopEverything()
    LocalPlayer.Character:BreakJoints()
end

--// CHAT HANDLER --------------------------------------------------
local function OnChat(msg)
    msg = msg:lower():gsub("^%s*(.-)%s*$", "%1")

    if msg == ".summon" then Summon()
    elseif msg == ".vanish" then Vanish()
    elseif msg == ".float" then Float()
    elseif msg == ".shotgun" then Shotgun()
    elseif msg == ".tp" then Teleport()
    elseif msg == ".stop" then StopEverything()
    elseif msg == ".jump" then Jump()
    elseif msg == ".sit" then Sit()
    elseif msg == ".fall" then Fall()
    elseif msg == ".tweak" then Tweak()
    elseif msg:find("^%.fling ") then
        local name = msg:match("^%.fling%s+(.+)")
        if name then StartFling(name) end
    end
end

--// UI – PICK MAIN ACCOUNT (ALPHABETICAL ORDER) ------------------
local function BuildUI()
    local sg = Instance.new("ScreenGui", game:GetService("CoreGui"))
    sg.Name = "AltControlUI"
    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0,200,0,300)
    frame.Position = UDim2.new(0,10,0,10)
    frame.BackgroundColor3 = Color3.fromRGB(30,30,30)

    local layout = Instance.new("UIListLayout", frame)
    layout.SortOrder = Enum.SortOrder.Name  -- Ensures alphabetical order

    local function addBtn(pl)
        local btn = Instance.new("TextButton", frame)
        btn.Size = UDim2.new(1,0,0,30)
        btn.Text = pl.Name
        btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
        btn.TextColor3 = Color3.new(1,1,1)
        btn.Name = pl.Name  -- Crucial for SortOrder.Name
        btn.MouseButton1Click:Connect(function()
            MainAccount = pl
            if ChatConn then ChatConn:Disconnect() end
            ChatConn = pl.Chatted:Connect(OnChat)
            print("[ALT] Main set →", pl.Name)
        end)
    end

    -- Add existing players in alphabetical order
    local players = Players:GetPlayers()
    table.sort(players, function(a, b)
        return a.Name:lower() < b.Name:lower()
    end)

    for _, pl in ipairs(players) do
        if pl ~= LocalPlayer then
            addBtn(pl)
        end
    end

    -- Add new players and maintain order
    Players.PlayerAdded:Connect(function(pl)
        if pl ~= LocalPlayer then
            addBtn(pl)
            -- Re-sort all buttons
            local buttons = {}
            for _, child in ipairs(frame:GetChildren()) do
                if child:IsA("TextButton") then
                    table.insert(buttons, child)
                end
            end
            table.sort(buttons, function(a, b)
                return a.Name:lower() < b.Name:lower()
            end)
            for i, btn in ipairs(buttons) do
                btn.LayoutOrder = i
            end
        end
    end)
end

BuildUI()
