-- Advanced Conjoined GUI Script for Roblox
-- Left side: Spectate players | Right side: TP Attack system

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Variables
local spectatingPlayer = nil
local startPosition = nil
local isTeleporting = false
local originalCameraSubject = Camera.CameraSubject
local isFlying = false
local flyConnection = nil
local flySpeed = 65
local isAirball = false
local airballConnection = nil
local savedAirballPosition = nil
local autoTpEnabled = false
local autoTpTarget = nil
local autoTpConnection = nil

-- Create Main GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ConjoinedGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Main Frame (Conjoined Container)
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 900, 0, 400)
MainFrame.Position = UDim2.new(0.5, -450, 0.5, -200)
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

-- Add rounded corners
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 35)
TitleBar.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 10)
TitleCorner.Parent = TitleBar

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, 0, 1, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "Cumbat Control Panel (Big Health Version)"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 16
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.Parent = TitleBar

-- Left Side (Spectate)
local LeftFrame = Instance.new("Frame")
LeftFrame.Name = "LeftFrame"
LeftFrame.Size = UDim2.new(0.333, -2, 1, -82)
LeftFrame.Position = UDim2.new(0, 0, 0, 37)
LeftFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
LeftFrame.BorderSizePixel = 0
LeftFrame.Parent = MainFrame

local LeftTitle = Instance.new("TextLabel")
LeftTitle.Size = UDim2.new(1, 0, 0, 30)
LeftTitle.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
LeftTitle.BorderSizePixel = 0
LeftTitle.Text = "SPECTATE"
LeftTitle.TextColor3 = Color3.fromRGB(100, 200, 255)
LeftTitle.TextSize = 14
LeftTitle.Font = Enum.Font.GothamBold
LeftTitle.Parent = LeftFrame

-- Spectate Player List (ScrollingFrame)
local SpectateList = Instance.new("ScrollingFrame")
SpectateList.Name = "SpectateList"
SpectateList.Size = UDim2.new(1, -10, 1, -40)
SpectateList.Position = UDim2.new(0, 5, 0, 35)
SpectateList.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
SpectateList.BorderSizePixel = 0
SpectateList.ScrollBarThickness = 6
SpectateList.Parent = LeftFrame

local SpectateListLayout = Instance.new("UIListLayout")
SpectateListLayout.SortOrder = Enum.SortOrder.Name
SpectateListLayout.Padding = UDim.new(0, 5)
SpectateListLayout.Parent = SpectateList

-- Right Side (TP Attack)
local RightFrame = Instance.new("Frame")
RightFrame.Name = "RightFrame"
RightFrame.Size = UDim2.new(0.333, -2, 1, -82)
RightFrame.Position = UDim2.new(0.333, 2, 0, 37)
RightFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
RightFrame.BorderSizePixel = 0
RightFrame.Parent = MainFrame

local RightTitle = Instance.new("TextLabel")
RightTitle.Size = UDim2.new(1, 0, 0, 30)
RightTitle.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
RightTitle.BorderSizePixel = 0
RightTitle.Text = "TP ATTACK"
RightTitle.TextColor3 = Color3.fromRGB(255, 100, 100)
RightTitle.TextSize = 14
RightTitle.Font = Enum.Font.GothamBold
RightTitle.Parent = RightFrame

-- TP Player List (ScrollingFrame)
local TPList = Instance.new("ScrollingFrame")
TPList.Name = "TPList"
TPList.Size = UDim2.new(1, -10, 1, -40)
TPList.Position = UDim2.new(0, 5, 0, 35)
TPList.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
TPList.BorderSizePixel = 0
TPList.ScrollBarThickness = 6
TPList.Parent = RightFrame

local TPListLayout = Instance.new("UIListLayout")
TPListLayout.SortOrder = Enum.SortOrder.Name
TPListLayout.Padding = UDim.new(0, 5)
TPListLayout.Parent = TPList

-- Third Side (Simple Teleport)
local ThirdFrame = Instance.new("Frame")
ThirdFrame.Name = "ThirdFrame"
ThirdFrame.Size = UDim2.new(0.333, -2, 1, -82)
ThirdFrame.Position = UDim2.new(0.666, 4, 0, 37)
ThirdFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
ThirdFrame.BorderSizePixel = 0
ThirdFrame.Parent = MainFrame

local ThirdTitle = Instance.new("TextLabel")
ThirdTitle.Size = UDim2.new(1, 0, 0, 30)
ThirdTitle.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
ThirdTitle.BorderSizePixel = 0
ThirdTitle.Text = "TELEPORT"
ThirdTitle.TextColor3 = Color3.fromRGB(100, 255, 150)
ThirdTitle.TextSize = 14
ThirdTitle.Font = Enum.Font.GothamBold
ThirdTitle.Parent = ThirdFrame

-- Simple TP Player List (ScrollingFrame)
local SimpleTpList = Instance.new("ScrollingFrame")
SimpleTpList.Name = "SimpleTpList"
SimpleTpList.Size = UDim2.new(1, -10, 1, -40)
SimpleTpList.Position = UDim2.new(0, 5, 0, 35)
SimpleTpList.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
SimpleTpList.BorderSizePixel = 0
SimpleTpList.ScrollBarThickness = 6
SimpleTpList.Parent = ThirdFrame

local SimpleTpListLayout = Instance.new("UIListLayout")
SimpleTpListLayout.SortOrder = Enum.SortOrder.Name
SimpleTpListLayout.Padding = UDim.new(0, 5)
SimpleTpListLayout.Parent = SimpleTpList

-- Divider Line 1 (between left and middle)
local Divider = Instance.new("Frame")
Divider.Size = UDim2.new(0, 2, 1, -82)
Divider.Position = UDim2.new(0.333, -1, 0, 37)
Divider.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
Divider.BorderSizePixel = 0
Divider.Parent = MainFrame

-- Divider Line 2 (between middle and right)
local Divider2 = Instance.new("Frame")
Divider2.Size = UDim2.new(0, 2, 1, -82)
Divider2.Position = UDim2.new(0.666, 1, 0, 37)
Divider2.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
Divider2.BorderSizePixel = 0
Divider2.Parent = MainFrame

-- Bottom Buttons Container
local BottomFrame = Instance.new("Frame")
BottomFrame.Name = "BottomFrame"
BottomFrame.Size = UDim2.new(1, 0, 0, 45)
BottomFrame.Position = UDim2.new(0, 0, 1, -45)
BottomFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
BottomFrame.BorderSizePixel = 0
BottomFrame.Parent = MainFrame

-- Set Start Position Button (Bottom 1/6)
local SetStartButton = Instance.new("TextButton")
SetStartButton.Name = "SetStartButton"
SetStartButton.Size = UDim2.new(0.1666, -4, 0, 35)
SetStartButton.Position = UDim2.new(0, 5, 0, 5)
SetStartButton.BackgroundColor3 = Color3.fromRGB(70, 130, 180)
SetStartButton.Text = "Set Start"
SetStartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SetStartButton.TextSize = 8
SetStartButton.Font = Enum.Font.GothamBold
SetStartButton.Parent = BottomFrame

local SetStartCorner = Instance.new("UICorner")
SetStartCorner.CornerRadius = UDim.new(0, 5)
SetStartCorner.Parent = SetStartButton

-- Fly Toggle Button (Bottom 2/6)
local FlyButton = Instance.new("TextButton")
FlyButton.Name = "FlyButton"
FlyButton.Size = UDim2.new(0.1666, -4, 0, 35)
FlyButton.Position = UDim2.new(0.1666, 2, 0, 5)
FlyButton.BackgroundColor3 = Color3.fromRGB(180, 70, 70)
FlyButton.Text = "Fly: OFF"
FlyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
FlyButton.TextSize = 8
FlyButton.Font = Enum.Font.GothamBold
FlyButton.Parent = BottomFrame

local FlyCorner = Instance.new("UICorner")
FlyCorner.CornerRadius = UDim.new(0, 5)
FlyCorner.Parent = FlyButton

-- TP to Start Button (Bottom 3/6)
local TPStartButton = Instance.new("TextButton")
TPStartButton.Name = "TPStartButton"
TPStartButton.Size = UDim2.new(0.1666, -4, 0, 35)
TPStartButton.Position = UDim2.new(0.3333, 0, 0, 5)
TPStartButton.BackgroundColor3 = Color3.fromRGB(130, 180, 70)
TPStartButton.Text = "TP Start"
TPStartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
TPStartButton.TextSize = 8
TPStartButton.Font = Enum.Font.GothamBold
TPStartButton.Parent = BottomFrame

local TPStartCorner = Instance.new("UICorner")
TPStartCorner.CornerRadius = UDim.new(0, 5)
TPStartCorner.Parent = TPStartButton

-- Airball Button (Bottom 4/6)
local AirballButton = Instance.new("TextButton")
AirballButton.Name = "AirballButton"
AirballButton.Size = UDim2.new(0.1666, -4, 0, 35)
AirballButton.Position = UDim2.new(0.5, -2, 0, 5)
AirballButton.BackgroundColor3 = Color3.fromRGB(150, 100, 200)
AirballButton.Text = "Airball"
AirballButton.TextColor3 = Color3.fromRGB(255, 255, 255)
AirballButton.TextSize = 8
AirballButton.Font = Enum.Font.GothamBold
AirballButton.Parent = BottomFrame

local AirballCorner = Instance.new("UICorner")
AirballCorner.CornerRadius = UDim.new(0, 5)
AirballCorner.Parent = AirballButton

-- Reset Camera Button (Bottom 5/6)
local ResetCamButton = Instance.new("TextButton")
ResetCamButton.Name = "ResetCamButton"
ResetCamButton.Size = UDim2.new(0.1666, -4, 0, 35)
ResetCamButton.Position = UDim2.new(0.6666, -4, 0, 5)
ResetCamButton.BackgroundColor3 = Color3.fromRGB(200, 150, 50)
ResetCamButton.Text = "Reset Cam"
ResetCamButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ResetCamButton.TextSize = 8
ResetCamButton.Font = Enum.Font.GothamBold
ResetCamButton.Parent = BottomFrame

local ResetCamCorner = Instance.new("UICorner")
ResetCamCorner.CornerRadius = UDim.new(0, 5)
ResetCamCorner.Parent = ResetCamButton

-- Auto TP Container (Bottom 6/6)
local AutoTpContainer = Instance.new("Frame")
AutoTpContainer.Name = "AutoTpContainer"
AutoTpContainer.Size = UDim2.new(0.1666, -4, 0, 35)
AutoTpContainer.Position = UDim2.new(0.8333, -6, 0, 5)
AutoTpContainer.BackgroundTransparency = 1
AutoTpContainer.Parent = BottomFrame

-- Auto TP Button
local AutoTpButton = Instance.new("TextButton")
AutoTpButton.Name = "AutoTpButton"
AutoTpButton.Size = UDim2.new(1, -20, 1, 0)
AutoTpButton.Position = UDim2.new(0, 0, 0, 0)
AutoTpButton.BackgroundColor3 = Color3.fromRGB(255, 100, 150)
AutoTpButton.Text = "Auto TP"
AutoTpButton.TextColor3 = Color3.fromRGB(255, 255, 255)
AutoTpButton.TextSize = 8
AutoTpButton.Font = Enum.Font.GothamBold
AutoTpButton.Parent = AutoTpContainer

local AutoTpCorner = Instance.new("UICorner")
AutoTpCorner.CornerRadius = UDim.new(0, 5)
AutoTpCorner.Parent = AutoTpButton

-- Arrow Button for Dropdown
local ArrowButton = Instance.new("TextButton")
ArrowButton.Name = "ArrowButton"
ArrowButton.Size = UDim2.new(0, 18, 1, 0)
ArrowButton.Position = UDim2.new(1, -18, 0, 0)
ArrowButton.BackgroundColor3 = Color3.fromRGB(200, 80, 120)
ArrowButton.Text = "▼"
ArrowButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ArrowButton.TextSize = 10
ArrowButton.Font = Enum.Font.GothamBold
ArrowButton.Parent = AutoTpContainer

local ArrowCorner = Instance.new("UICorner")
ArrowCorner.CornerRadius = UDim.new(0, 5)
ArrowCorner.Parent = ArrowButton

-- Dropdown List for Auto TP
local AutoTpDropdown = Instance.new("ScrollingFrame")
AutoTpDropdown.Name = "AutoTpDropdown"
AutoTpDropdown.Size = UDim2.new(1, 0, 0, 0)
AutoTpDropdown.Position = UDim2.new(0, 0, 1, 5)
AutoTpDropdown.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
AutoTpDropdown.BorderSizePixel = 1
AutoTpDropdown.BorderColor3 = Color3.fromRGB(200, 80, 120)
AutoTpDropdown.ScrollBarThickness = 4
AutoTpDropdown.Visible = false
AutoTpDropdown.ZIndex = 10
AutoTpDropdown.Parent = AutoTpContainer

local AutoTpDropdownCorner = Instance.new("UICorner")
AutoTpDropdownCorner.CornerRadius = UDim.new(0, 5)
AutoTpDropdownCorner.Parent = AutoTpDropdown

local AutoTpDropdownLayout = Instance.new("UIListLayout")
AutoTpDropdownLayout.SortOrder = Enum.SortOrder.Name
AutoTpDropdownLayout.Padding = UDim.new(0, 2)
AutoTpDropdownLayout.Parent = AutoTpDropdown

-- Functions
local function stopFlying()
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    isFlying = false
    
    local character = LocalPlayer.Character
    if character then
        local humanoidRoot = character:FindFirstChild("HumanoidRootPart")
        if humanoidRoot then
            -- Remove fly components
            for _, v in pairs(humanoidRoot:GetChildren()) do
                if v:IsA("BodyVelocity") or v:IsA("BodyGyro") then
                    v:Destroy()
                end
            end
        end
    end
end

local function startFlying()
    if isFlying then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoidRoot = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRoot then return end
    
    isFlying = true
    
    -- Create body movers
    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.MaxForce = Vector3.new(100000, 100000, 100000)
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.Parent = humanoidRoot
    
    local bodyGyro = Instance.new("BodyGyro")
    bodyGyro.MaxTorque = Vector3.new(100000, 100000, 100000)
    bodyGyro.P = 10000
    bodyGyro.Parent = humanoidRoot
    
    local userInputService = game:GetService("UserInputService")
    
    flyConnection = RunService.Heartbeat:Connect(function()
        if not isFlying or not character.Parent or not humanoidRoot.Parent then
            stopFlying()
            return
        end
        
        local camera = workspace.CurrentCamera
        local moveDirection = Vector3.new(0, 0, 0)
        
        -- WASD movement
        if userInputService:IsKeyDown(Enum.KeyCode.W) then
            moveDirection = moveDirection + (camera.CFrame.LookVector)
        end
        if userInputService:IsKeyDown(Enum.KeyCode.S) then
            moveDirection = moveDirection - (camera.CFrame.LookVector)
        end
        if userInputService:IsKeyDown(Enum.KeyCode.A) then
            moveDirection = moveDirection - (camera.CFrame.RightVector)
        end
        if userInputService:IsKeyDown(Enum.KeyCode.D) then
            moveDirection = moveDirection + (camera.CFrame.RightVector)
        end
        
        -- Vertical movement
        if userInputService:IsKeyDown(Enum.KeyCode.Space) then
            moveDirection = moveDirection + Vector3.new(0, 1, 0)
        end
        if userInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            moveDirection = moveDirection - Vector3.new(0, 1, 0)
        end
        
        if moveDirection.Magnitude > 0 then
            moveDirection = moveDirection.Unit
        end
        
        if bodyVelocity and bodyVelocity.Parent then
            bodyVelocity.Velocity = moveDirection * flySpeed
        end
        if bodyGyro and bodyGyro.Parent then
            bodyGyro.CFrame = camera.CFrame
        end
    end)
end

local function stopAirball()
    if airballConnection then
        airballConnection:Disconnect()
        airballConnection = nil
    end
    isAirball = false
    
    -- Return to start position
    if startPosition then
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = startPosition
        end
    end
    
    -- Remove airball components
    local character = LocalPlayer.Character
    if character then
        local humanoidRoot = character:FindFirstChild("HumanoidRootPart")
        if humanoidRoot then
            for _, v in pairs(humanoidRoot:GetChildren()) do
                if v.Name == "AirballPosition" then
                    v:Destroy()
                end
            end
        end
    end
end

local function stopAutoTp()
    if autoTpConnection then
        autoTpConnection:Disconnect()
        autoTpConnection = nil
    end
    autoTpEnabled = false
    autoTpTarget = nil
end

local function startAutoTp(targetPlayer)
    if not targetPlayer then return end
    
    autoTpEnabled = true
    autoTpTarget = targetPlayer
    
    -- Function to teleport to target (IN FRONT)
    local function teleportToTarget()
        if not autoTpTarget or not autoTpTarget.Character then return end
        local targetRoot = autoTpTarget.Character:FindFirstChild("HumanoidRootPart")
        if targetRoot and LocalPlayer.Character then
            local humanoidRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if humanoidRoot then
                -- Teleport IN FRONT of target (negative Z = in front)
                humanoidRoot.CFrame = targetRoot.CFrame * CFrame.new(0, 0, -3)
            end
        end
    end
    
    -- Function to do the 3x teleport sequence
    local function doTeleportSequence()
        if not autoTpEnabled then return end
        
        -- Teleport 5 times with 0.35 second delays
        for i = 1, 3 do
            if not autoTpEnabled then break end
            teleportToTarget()
            if i < 3 then
                wait(2.0)
            end
        end
    end
    
    -- Initial teleport
    teleportToTarget()
    
    -- Setup respawn detection
    LocalPlayer.CharacterAdded:Connect(function(character)
        if not autoTpEnabled then return end
        
        local humanoidRoot = character:WaitForChild("HumanoidRootPart")
        wait(1.5) -- Small delay for spawn
        
        doTeleportSequence()
        
        -- Detect spawn point touches
        humanoidRoot.Touched:Connect(function(hit)
            if not autoTpEnabled then return end
            
            -- Check if touched a spawn location
            if hit:IsA("SpawnLocation") or hit.Name == "SpawnLocation" or hit.Parent:IsA("SpawnLocation") then
                wait(0.5) -- Small delay
                doTeleportSequence()
            end
        end)
    end)
end

local function createAutoTpDropdownButton(player)
    local button = Instance.new("TextButton")
    button.Name = player.Name
    button.Size = UDim2.new(1, -5, 0, 25)
    button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    button.Text = player.DisplayName
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 9
    button.Font = Enum.Font.Gotham
    button.ZIndex = 11
    button.Parent = AutoTpDropdown
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 3)
    corner.Parent = button
    
    button.MouseButton1Click:Connect(function()
        if autoTpEnabled and autoTpTarget == player then
            -- Disable auto TP
            stopAutoTp()
            AutoTpButton.Text = "Auto TP"
            AutoTpButton.BackgroundColor3 = Color3.fromRGB(255, 100, 150)
        else
            -- Enable auto TP to this player
            stopAutoTp()
            startAutoTp(player)
            AutoTpButton.Text = player.DisplayName
            AutoTpButton.BackgroundColor3 = Color3.fromRGB(100, 255, 150)
        end
        
        -- Close dropdown
        AutoTpDropdown.Visible = false
        ArrowButton.Text = "▼"
        
        -- Update button colors
        for _, btn in pairs(AutoTpDropdown:GetChildren()) do
            if btn:IsA("TextButton") then
                if autoTpEnabled and autoTpTarget and btn.Name == autoTpTarget.Name then
                    btn.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
                else
                    btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                end
            end
        end
    end)
    
    return button
end

local function updateAutoTpDropdown()
    -- Clear existing buttons
    for _, child in pairs(AutoTpDropdown:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    -- Create buttons for each player
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            createAutoTpDropdownButton(player)
        end
    end
    
    -- Update canvas size
    local contentHeight = AutoTpDropdownLayout.AbsoluteContentSize.Y
    AutoTpDropdown.CanvasSize = UDim2.new(0, 0, 0, contentHeight + 5)
end

local function startAirball()
    if isAirball then return end
    if not startPosition then
        warn("Please set a start position first!")
        return
    end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoidRoot = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRoot then return end
    
    isAirball = true
    
    -- Save current position and teleport super high
    savedAirballPosition = humanoidRoot.CFrame
    local highPosition = CFrame.new(humanoidRoot.Position.X, 10000, humanoidRoot.Position.Z)
    humanoidRoot.CFrame = highPosition
    
    -- Create position anchor
    local bodyPosition = Instance.new("BodyPosition")
    bodyPosition.Name = "AirballPosition"
    bodyPosition.MaxForce = Vector3.new(100000, 100000, 100000)
    bodyPosition.Position = highPosition.Position
    bodyPosition.P = 10000
    bodyPosition.D = 500
    bodyPosition.Parent = humanoidRoot
    
    local bodyGyro = Instance.new("BodyGyro")
    bodyGyro.Name = "AirballPosition"
    bodyGyro.MaxTorque = Vector3.new(100000, 100000, 100000)
    bodyGyro.P = 10000
    bodyGyro.Parent = humanoidRoot
    
    airballConnection = RunService.Heartbeat:Connect(function()
        if not isAirball or not character.Parent or not humanoidRoot.Parent then
            stopAirball()
            return
        end
        
        -- Keep character at high position
        if bodyPosition and bodyPosition.Parent then
            bodyPosition.Position = Vector3.new(humanoidRoot.Position.X, 10000, humanoidRoot.Position.Z)
        end
        
        if bodyGyro and bodyGyro.Parent then
            bodyGyro.CFrame = workspace.CurrentCamera.CFrame
        end
    end)
end
local function stopSpectating()
    if spectatingPlayer then
        Camera.CameraSubject = originalCameraSubject
        spectatingPlayer = nil
    end
end

local function spectatePlayer(player)
    if player and player.Character and player.Character:FindFirstChild("Humanoid") then
        if spectatingPlayer == player then
            stopSpectating()
        else
            spectatingPlayer = player
            Camera.CameraSubject = player.Character.Humanoid
        end
    end
end

local function createSpectateButton(player)
    local button = Instance.new("TextButton")
    button.Name = player.Name
    button.Size = UDim2.new(1, -10, 0, 30)
    button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    button.Text = player.DisplayName
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 12
    button.Font = Enum.Font.Gotham
    button.Parent = SpectateList
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 5)
    corner.Parent = button
    
    button.MouseButton1Click:Connect(function()
        spectatePlayer(player)
        -- Update button color
        for _, btn in pairs(SpectateList:GetChildren()) do
            if btn:IsA("TextButton") then
                if spectatingPlayer and btn.Name == spectatingPlayer.Name then
                    btn.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
                else
                    btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                end
            end
        end
    end)
    
    return button
end

local function teleportAttack(targetPlayer)
    if isTeleporting then return end
    if not startPosition then
        warn("Please set a start position first!")
        return
    end
    
    if not targetPlayer or not targetPlayer.Character then return end
    
    local targetHumanoid = targetPlayer.Character:FindFirstChild("Humanoid")
    local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    
    if not targetHumanoid or not targetRoot then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoidRoot = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRoot then return end
    
    isTeleporting = true
    
    -- Enable fly at the start of attack
    if not isFlying then
        startFlying()
        FlyButton.Text = "Fly: ON"
        FlyButton.BackgroundColor3 = Color3.fromRGB(70, 180, 70)
    end
    
    local startTime = tick()
    local healthDropped = false
    
    local connection
    connection = RunService.Heartbeat:Connect(function()
        local elapsed = tick() - startTime
        
        -- Check if target health is below 20
        if targetHumanoid.Health < 20 then
            healthDropped = true
            wait(3.5)
            humanoidRoot.CFrame = startPosition
            -- Disable fly when returning to start
            if isFlying then
                stopFlying()
                FlyButton.Text = "Fly: OFF"
                FlyButton.BackgroundColor3 = Color3.fromRGB(180, 70, 70)
            end
            isTeleporting = false
            connection:Disconnect()
            return
        end
        
        -- Teleport behind target for 3.5 seconds
        if elapsed < 4.0 then
            if targetRoot and humanoidRoot then
                -- Position 1 stud behind target
                humanoidRoot.CFrame = targetRoot.CFrame * CFrame.new(0, 0, 1)
            end
        else
            -- Time's up, return to start
            humanoidRoot.CFrame = startPosition
            -- Disable fly when returning to start
            if isFlying then
                stopFlying()
                FlyButton.Text = "Fly: OFF"
                FlyButton.BackgroundColor3 = Color3.fromRGB(180, 70, 70)
            end
            isTeleporting = false
            connection:Disconnect()
        end
    end)
end

local function createTPButton(player)
    local button = Instance.new("TextButton")
    button.Name = player.Name
    button.Size = UDim2.new(1, -10, 0, 30)
    button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    button.Text = player.DisplayName
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 12
    button.Font = Enum.Font.Gotham
    button.Parent = TPList
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 5)
    corner.Parent = button
    
    button.MouseButton1Click:Connect(function()
        teleportAttack(player)
    end)
    
    return button
end

local function createSimpleTpButton(player)
    local button = Instance.new("TextButton")
    button.Name = player.Name
    button.Size = UDim2.new(1, -10, 0, 30)
    button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    button.Text = player.DisplayName
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 12
    button.Font = Enum.Font.Gotham
    button.Parent = SimpleTpList
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 5)
    corner.Parent = button
    
    button.MouseButton1Click:Connect(function()
        if player and player.Character then
            local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
            if targetRoot and LocalPlayer.Character then
                local humanoidRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if humanoidRoot then
                    humanoidRoot.CFrame = targetRoot.CFrame * CFrame.new(0, 0, 3)
                end
            end
        end
    end)
    
    return button
end

local function updatePlayerLists()
    -- Clear existing buttons
    for _, child in pairs(SpectateList:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    for _, child in pairs(TPList:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    for _, child in pairs(SimpleTpList:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    -- Create new buttons for each player
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            createSpectateButton(player)
            createTPButton(player)
            createSimpleTpButton(player)
        end
    end
    
    -- Update canvas size
    SpectateList.CanvasSize = UDim2.new(0, 0, 0, SpectateListLayout.AbsoluteContentSize.Y + 10)
    TPList.CanvasSize = UDim2.new(0, 0, 0, TPListLayout.AbsoluteContentSize.Y + 10)
    SimpleTpList.CanvasSize = UDim2.new(0, 0, 0, SimpleTpListLayout.AbsoluteContentSize.Y + 10)
    
    -- Update auto TP dropdown
    updateAutoTpDropdown()
end

-- Set Start Position Button Click
SetStartButton.MouseButton1Click:Connect(function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        startPosition = LocalPlayer.Character.HumanoidRootPart.CFrame
        SetStartButton.Text = "Pos Set!"
        SetStartButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        
        wait(1)
        SetStartButton.Text = "Set Start"
        SetStartButton.BackgroundColor3 = Color3.fromRGB(70, 130, 180)
    end
end)

-- Fly Button Click
FlyButton.MouseButton1Click:Connect(function()
    if isFlying then
        stopFlying()
        FlyButton.Text = "Fly: OFF"
        FlyButton.BackgroundColor3 = Color3.fromRGB(180, 70, 70)
    else
        startFlying()
        FlyButton.Text = "Fly: ON"
        FlyButton.BackgroundColor3 = Color3.fromRGB(70, 180, 70)
    end
end)

-- TP to Start Button Click
TPStartButton.MouseButton1Click:Connect(function()
    if not startPosition then
        warn("Please set a start position first!")
        TPStartButton.Text = "No Start!"
        wait(1)
        TPStartButton.Text = "TP Start"
        return
    end
    
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame = startPosition
        TPStartButton.Text = "Teleported!"
        TPStartButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        
        wait(0.5)
        TPStartButton.Text = "TP Start"
        TPStartButton.BackgroundColor3 = Color3.fromRGB(130, 180, 70)
    end
end)

-- Airball Button Click
AirballButton.MouseButton1Click:Connect(function()
    if isAirball then
        stopAirball()
        AirballButton.Text = "Airball"
        AirballButton.BackgroundColor3 = Color3.fromRGB(150, 100, 200)
    else
        if not startPosition then
            warn("Please set a start position first!")
            AirballButton.Text = "No Start!"
            wait(1)
            AirballButton.Text = "Airball"
            return
        end
        startAirball()
        AirballButton.Text = "Airball: ON"
        AirballButton.BackgroundColor3 = Color3.fromRGB(200, 100, 255)
    end
end)

-- Reset Camera Button Click
ResetCamButton.MouseButton1Click:Connect(function()
    stopSpectating()
    Camera.CameraSubject = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") or originalCameraSubject
    
    ResetCamButton.Text = "Reset!"
    ResetCamButton.BackgroundColor3 = Color3.fromRGB(255, 200, 50)
    
    -- Update spectate button colors
    for _, btn in pairs(SpectateList:GetChildren()) do
        if btn:IsA("TextButton") then
            btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        end
    end
    
    wait(0.5)
    ResetCamButton.Text = "Reset Cam"
    ResetCamButton.BackgroundColor3 = Color3.fromRGB(200, 150, 50)
end)

-- Auto TP Button Click (toggle on/off)
AutoTpButton.MouseButton1Click:Connect(function()
    if autoTpEnabled then
        stopAutoTp()
        AutoTpButton.Text = "Auto TP"
        AutoTpButton.BackgroundColor3 = Color3.fromRGB(255, 100, 150)
        
        -- Update dropdown button colors
        for _, btn in pairs(AutoTpDropdown:GetChildren()) do
            if btn:IsA("TextButton") then
                btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
            end
        end
    end
end)

-- Arrow Button Click (toggle dropdown)
ArrowButton.MouseButton1Click:Connect(function()
    AutoTpDropdown.Visible = not AutoTpDropdown.Visible
    
    if AutoTpDropdown.Visible then
        ArrowButton.Text = "▲"
        -- Set dropdown height based on content (max 120px)
        local contentHeight = AutoTpDropdownLayout.AbsoluteContentSize.Y
        local maxHeight = 120
        AutoTpDropdown.Size = UDim2.new(1, 0, 0, math.min(contentHeight + 5, maxHeight))
    else
        ArrowButton.Text = "▼"
    end
end)

-- Player Added/Removed Events
Players.PlayerAdded:Connect(function()
    wait(0.5)
    updatePlayerLists()
end)

Players.PlayerRemoving:Connect(function(player)
    if spectatingPlayer == player then
        stopSpectating()
    end
    if autoTpEnabled and autoTpTarget == player then
        stopAutoTp()
        AutoTpButton.Text = "Auto TP"
        AutoTpButton.BackgroundColor3 = Color3.fromRGB(255, 100, 150)
    end
    updatePlayerLists()
end)

-- Make GUI Draggable
local dragging
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

TitleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

RunService.Heartbeat:Connect(function()
    if dragging and dragInput then
        update(dragInput)
    end
end)

-- Initial player list update
updatePlayerLists()

print("Advanced Conjoined GUI loaded successfully!")
