local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local SelectedMainAccount = nil
local Following = false
local Connection = nil
local Vanishing = false

-- Stop all ongoing actions before switching commands
local function StopAll()
    Following = false
    Vanishing = false
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = 16
        LocalPlayer.Character.Humanoid.JumpPower = 50
    end
    print("‚úÖ Stopped all actions")
end

-- Disable collisions
local function SetCollisions(character, state)
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = state
            part.CanTouch = state
        end
    end
end

-- Floating movement function
local function ApplyFloatingMovement(character, targetOffset)
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    for _, obj in ipairs(hrp:GetChildren()) do
        if obj:IsA("AlignPosition") or obj:IsA("AlignOrientation") then
            obj:Destroy()
        end
    end

    local alignPos = Instance.new("AlignPosition")
    alignPos.MaxForce = 100000
    alignPos.Responsiveness = 100
    alignPos.RigidityEnabled = true
    alignPos.Parent = hrp

    local alignOri = Instance.new("AlignOrientation")
    alignOri.MaxTorque = 100000
    alignOri.Responsiveness = 100
    alignOri.RigidityEnabled = true
    alignOri.Parent = hrp

    local attachment0 = Instance.new("Attachment", hrp)
    local targetAttachment = Instance.new("Attachment")

    alignPos.Attachment0 = attachment0
    alignPos.Attachment1 = targetAttachment
    alignOri.Attachment0 = attachment0
    alignOri.Attachment1 = targetAttachment

    task.spawn(function()
        while Following and SelectedMainAccount and SelectedMainAccount.Character do
            local targetHRP = SelectedMainAccount.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP then
                targetAttachment.Parent = targetHRP
                targetAttachment.Position = targetOffset
            end
            task.wait(0.1)
        end

        alignPos:Destroy()
        alignOri:Destroy()
        targetAttachment:Destroy()
        attachment0:Destroy()
    end)
end

-- Pummel Alt
local function PummelAlt(targetName)
    StopAll()
    if not SelectedMainAccount or not SelectedMainAccount.Character then
        warn("‚ö†Ô∏è Pummel failed: No main account selected")
        return
    end

    local TargetPlayer = Players:FindFirstChild(targetName)
    if not TargetPlayer or not TargetPlayer.Character then
        warn("‚ö†Ô∏è Pummel failed: Target player not found or no character available")
        return
    end

    local AltChar = LocalPlayer.Character
    local MainChar = SelectedMainAccount.Character
    local TargetChar = TargetPlayer.Character

    if not AltChar or not MainChar or not TargetChar then return end

    local MainHRP = MainChar:FindFirstChild("HumanoidRootPart")
    local AltHRP = AltChar:FindFirstChild("HumanoidRootPart")
    local TargetHRP = TargetChar:FindFirstChild("HumanoidRootPart")

    if not MainHRP or not AltHRP or not TargetHRP then
        warn("‚ö†Ô∏è Pummel failed: Missing HumanoidRootParts")
        return
    end

    local direction = (TargetHRP.Position - AltHRP.Position).unit -- Direction vector from alt to target
    local spinRadius = 5 -- Radius to spin around the target
    local spinSpeed = 5 -- Speed of spinning
    local pushSpeed = 100 -- Speed of pushing forward through the target
    local duration = 10 -- Pummel duration (10 seconds)
    local startTime = tick()

    -- Create a BodyVelocity to move forward while spinning
    local BodyVelocity = Instance.new("BodyVelocity", AltHRP)
    BodyVelocity.MaxForce = Vector3.new(100000, 100000, 100000)
    BodyVelocity.Velocity = direction * pushSpeed
    BodyVelocity.P = 10000
    BodyVelocity.D = 10000

    -- Start pummeling the target
    print("‚úÖ Alt starting pummel on target...")

    -- Function to move and spin around
    local function SpinAround()
        while tick() - startTime < duration do
            local elapsedTime = tick() - startTime
            local angle = elapsedTime * spinSpeed
            local offset = Vector3.new(math.sin(angle) * spinRadius, 0, math.cos(angle) * spinRadius)
            
            -- Update the alt's position to keep it spinning around the target
            AltHRP.CFrame = TargetHRP.CFrame * CFrame.new(offset) -- Move the alt around the target

            -- Push forward through the target
            BodyVelocity.Velocity = direction * pushSpeed

            task.wait(0.1)
        end

        BodyVelocity:Destroy() -- Remove BodyVelocity after the pummel is complete
        print("‚úÖ Pummel action finished.")
    end

    SpinAround() -- Call the spin function
end

-- Summon Alt
local function SummonAlt()
    StopAll()
    if not SelectedMainAccount or not SelectedMainAccount.Character then
        warn("‚ö†Ô∏è Summon failed: No main account selected")
        return
    end

    local MainChar = SelectedMainAccount.Character
    local AltChar = LocalPlayer.Character
    if not MainChar or not AltChar then return end

    Following = true
    print("‚úÖ Summoning Alt to the side...")

    AltChar.Humanoid.WalkSpeed = 0
    AltChar.Humanoid.JumpPower = 0

    ApplyFloatingMovement(AltChar, Vector3.new(7, 10, 0))
end

-- Fall Alt
local function FallAlt()
    LocalPlayer.Character:BreakJoints()
end

-- Sit Alt
local function SitAlt()
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("Humanoid") then
        warn("‚ö†Ô∏è Sit failed: No character found")
        return
    end

    local Humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
    Humanoid.Sit = true
    print("‚úÖ Alt is now sitting!")
end

-- Shotgun Alt (Now resets after firing)
local function ShotgunAlt()
    StopAll()
    if not SelectedMainAccount or not SelectedMainAccount.Character then
        warn("‚ö†Ô∏è Shotgun failed: No main account selected")
        return
    end

    local AltChar = LocalPlayer.Character
    local MainChar = SelectedMainAccount.Character
    if not AltChar or not MainChar then return end

    local MainHRP = MainChar:FindFirstChild("HumanoidRootPart")
    local AltHRP = AltChar:FindFirstChild("HumanoidRootPart")
    local RightArm = MainChar:FindFirstChild("Right Arm") or MainChar:FindFirstChild("RightHand")

    if not MainHRP or not AltHRP or not RightArm then
        warn("‚ö†Ô∏è Shotgun failed: Missing required parts")
        return
    end

    print("‚úÖ Alt moving to arm for Shotgun...")

    local AlignPos = Instance.new("AlignPosition", AltHRP)
    AlignPos.MaxForce = 100000
    AlignPos.Responsiveness = 100
    AlignPos.Attachment0 = Instance.new("Attachment", AltHRP)
    AlignPos.Attachment1 = Instance.new("Attachment", RightArm)

    task.wait(2)

    print("üöÄ Shotgun firing!")
    AlignPos:Destroy()

    local BodyVelocity = Instance.new("BodyVelocity", AltHRP)
    BodyVelocity.Velocity = MainHRP.CFrame.LookVector * 250
    BodyVelocity.MaxForce = Vector3.new(100000, 100000, 100000)

    task.wait(0.5)
    BodyVelocity:Destroy()

    task.wait(1)
    LocalPlayer.Character:BreakJoints() -- Reset after firing
end

-- Vanish Alt (Now Instantly Teleports 30 Studs Under Main)
local function VanishAlt()
    StopAll()
    if not SelectedMainAccount or not SelectedMainAccount.Character then
        warn("‚ö†Ô∏è Vanish failed: No main account selected")
        return
    end

    local AltChar = LocalPlayer.Character
    local MainChar = SelectedMainAccount.Character
    if not AltChar or not MainChar then return end

    local AltHRP = AltChar:FindFirstChild("HumanoidRootPart")
    local MainHRP = MainChar:FindFirstChild("HumanoidRootPart")
    
    if not AltHRP or not MainHRP then
        warn("‚ö†Ô∏è Vanish failed: Missing HumanoidRootPart")
        return
    end

    print("‚úÖ Instantly Vanishing Alt 30 studs underground...")

    -- Instantly Teleport the Alt 30 studs below the Main
    AltHRP.CFrame = MainHRP.CFrame + Vector3.new(0, -30, 0)

    -- Disable movement and collisions
    AltChar.Humanoid.WalkSpeed = 0
    AltChar.Humanoid.JumpPower = 0
    SetCollisions(AltChar, false)
end

-- Teleport Alt to Main Instantly
local function TeleportAlt()
    if not SelectedMainAccount or not SelectedMainAccount.Character then
        warn("‚ö†Ô∏è Teleport failed: No main account selected")
        return
    end

    local AltChar = LocalPlayer.Character
    local MainChar = SelectedMainAccount.Character
    if not AltChar or not MainChar then return end

    local MainHRP = MainChar:FindFirstChild("HumanoidRootPart")
    local AltHRP = AltChar:FindFirstChild("HumanoidRootPart")

    if MainHRP and AltHRP then
        AltHRP.CFrame = MainHRP.CFrame + Vector3.new(0, 5, 0)
        print("‚úÖ Teleported Alt to Main!")
    else
        warn("‚ö†Ô∏è Teleport failed: Missing parts")
    end
end

-- Command Handling
local function HandleChatCommand(message)
    if message == ".summon" then
        SummonAlt()
    elseif message == ".shotgun" then
        ShotgunAlt()
    elseif message == ".vanish" then
        VanishAlt()
    elseif message == ".tp" then
        TeleportAlt()
    elseif message == ".stop" then
        StopAll()
    elseif message == ".sit" then
        SitAlt()
    elseif message == ".jump" then
        JumpAlt()
    elseif message == ".fall" then
        FallAlt()
    elseif message:sub(1, 7) == ".pummel" then
        local targetName = message:sub(9) -- Get the username from the command
        if targetName and targetName ~= "" then
            PummelAlt(targetName)
        else
            warn("‚ö†Ô∏è Pummel failed: No target username provided")
        end
    else
        warn("‚ö†Ô∏è Unknown command:", message)
    end
end

-- UI Selection (Chat listener persists)
local function SetupSelectionUI()
    local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
    local Frame = Instance.new("Frame", ScreenGui)
    Frame.Size = UDim2.new(0, 200, 0, 300)
    Frame.Position = UDim2.new(0, 10, 0, 10)
    Frame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)

    local UIList = Instance.new("UIListLayout", Frame)

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local Button = Instance.new("TextButton", Frame)
            Button.Size = UDim2.new(1, 0, 0, 30)
            Button.Text = player.Name
            Button.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
            Button.TextColor3 = Color3.new(1, 1, 1)

            Button.MouseButton1Click:Connect(function()
                SelectedMainAccount = player
                print("‚úÖ Main Account Selected: " .. player.Name)

                if Connection then
                    Connection:Disconnect()
                end

                Connection = player.Chatted:Connect(function(msg)
                    HandleChatCommand(msg)
                end)
            end)
        end
    end
end

SetupSelectionUI()
