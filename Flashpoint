-- LocalScript inside StarterPlayerScripts

--// Setup
local plr = game.Players.LocalPlayer
local uis = game:GetService("UserInputService")
local rs = game:GetService("RunService")

-- Colors
local LAVENDER = Color3.fromRGB(200,180,255)
local DARK1 = Color3.fromRGB(20,20,20)
local DARK2 = Color3.fromRGB(30,30,30)
local DARK3 = Color3.fromRGB(40,40,40)

--// ScreenGui
local gui = Instance.new("ScreenGui")
gui.Name = "AdvancedSpeedGUI"
gui.Parent = plr:WaitForChild("PlayerGui")
gui.ResetOnSpawn = false

--// Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 280, 0, 60)
mainFrame.Position = UDim2.new(0.05, 0, 0.2, 0)
mainFrame.BackgroundColor3 = DARK1
mainFrame.BorderSizePixel = 0
mainFrame.Parent = gui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 12)

--// Topbar
local topBar = Instance.new("Frame")
topBar.Size = UDim2.new(1, 0, 0, 40)
topBar.BackgroundColor3 = DARK2
topBar.Parent = mainFrame
Instance.new("UICorner", topBar).CornerRadius = UDim.new(0, 12)

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -90, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Speed GUI"
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.TextColor3 = LAVENDER
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = topBar

-- Fullscreen + Minimize buttons
local fullBtn = Instance.new("TextButton")
fullBtn.Size = UDim2.new(0, 30, 0, 30)
fullBtn.Position = UDim2.new(1, -70, 0.5, -15)
fullBtn.Text = "⬜"
fullBtn.Font = Enum.Font.GothamBold
fullBtn.TextSize = 18
fullBtn.TextColor3 = LAVENDER
fullBtn.BackgroundColor3 = DARK3
fullBtn.Parent = topBar
Instance.new("UICorner", fullBtn).CornerRadius = UDim.new(0, 6)

local minBtn = Instance.new("TextButton")
minBtn.Size = UDim2.new(0, 30, 0, 30)
minBtn.Position = UDim2.new(1, -35, 0.5, -15)
minBtn.Text = "—"
minBtn.Font = Enum.Font.GothamBold
minBtn.TextSize = 18
minBtn.TextColor3 = LAVENDER
minBtn.BackgroundColor3 = DARK3
minBtn.Parent = topBar
Instance.new("UICorner", minBtn).CornerRadius = UDim.new(0, 6)

-- Content Frame
local content = Instance.new("Frame")
content.Size = UDim2.new(1, -20, 0, 0)
content.Position = UDim2.new(0, 10, 0, 50)
content.BackgroundTransparency = 1
content.Visible = true
content.Parent = mainFrame
content.AutomaticSize = Enum.AutomaticSize.Y

local listLayout = Instance.new("UIListLayout")
listLayout.Parent = content
listLayout.Padding = UDim.new(0, 6)

-- Dropdown helper
local function makeDropdown(name, options)
    local holder = Instance.new("Frame")
    holder.Size = UDim2.new(1,0,0,0)
    holder.AutomaticSize = Enum.AutomaticSize.Y
    holder.BackgroundTransparency = 1
    holder.Parent = content

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 35)
    frame.BackgroundColor3 = DARK2
    frame.Parent = holder
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, 0, 1, 0)
    btn.BackgroundTransparency = 1
    btn.Text = name.." ▼"
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 16
    btn.TextColor3 = LAVENDER
    btn.Parent = frame

    local dropFrame = Instance.new("Frame")
    dropFrame.Size = UDim2.new(1, 0, 0, 0)
    dropFrame.BackgroundColor3 = DARK1
    dropFrame.ClipsDescendants = true
    dropFrame.Visible = false
    dropFrame.Parent = holder
    dropFrame.AutomaticSize = Enum.AutomaticSize.Y
    Instance.new("UICorner", dropFrame).CornerRadius = UDim.new(0, 8)

    local layout = Instance.new("UIListLayout", dropFrame)
    layout.Padding = UDim.new(0, 4)

    local selected = options[1]
    for _, op in ipairs(options) do
        local b = Instance.new("TextButton")
        b.Size = UDim2.new(1, 0, 0, 25)
        b.BackgroundColor3 = DARK3
        b.Text = op
        b.Font = Enum.Font.Gotham
        b.TextSize = 14
        b.TextColor3 = LAVENDER
        b.Parent = dropFrame
        Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6)

        b.MouseButton1Click:Connect(function()
            selected = op
            btn.Text = name.." ("..op..") ▼"
            dropFrame.Visible = false
            mainFrame.Size = UDim2.new(0,280,0,content.AbsoluteSize.Y+60)
        end)
    end

    local open = false
    btn.MouseButton1Click:Connect(function()
        open = not open
        dropFrame.Visible = open
        mainFrame.Size = UDim2.new(0,280,0,content.AbsoluteSize.Y+60)
    end)

    return function() return selected end
end

-- Dropdowns
local getMethod = makeDropdown("Speed Method", {"WalkSpeed","CFrame","BodyVelocity","HRP Velocity"})
local getInputType = makeDropdown("Input Mode", {"Slider","NumberBox"})

-- Toggle Button
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1, 0, 0, 35)
toggleBtn.BackgroundColor3 = DARK3
toggleBtn.Text = "Enable: OFF"
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 16
toggleBtn.TextColor3 = LAVENDER
toggleBtn.Parent = content
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0, 8)

local enabled = false
toggleBtn.MouseButton1Click:Connect(function()
    enabled = not enabled
    toggleBtn.Text = "Enable: "..(enabled and "ON" or "OFF")
    toggleBtn.BackgroundColor3 = enabled and LAVENDER or DARK3
    toggleBtn.TextColor3 = enabled and DARK1 or LAVENDER
end)

-- Slider + NumberBox Frame
local valueFrame = Instance.new("Frame")
valueFrame.Size = UDim2.new(1, 0, 0, 50)
valueFrame.BackgroundColor3 = DARK2
valueFrame.Parent = content
Instance.new("UICorner", valueFrame).CornerRadius = UDim.new(0, 8)

local sliderBar = Instance.new("Frame")
sliderBar.Size = UDim2.new(1, -20, 0, 6)
sliderBar.Position = UDim2.new(0, 10, 0.5, -3)
sliderBar.BackgroundColor3 = DARK3
sliderBar.Parent = valueFrame

local sliderFill = Instance.new("Frame")
sliderFill.Size = UDim2.new(0, 0, 1, 0)
sliderFill.BackgroundColor3 = LAVENDER
sliderFill.Parent = sliderBar

local sliderBtn = Instance.new("TextButton")
sliderBtn.Size = UDim2.new(0, 12, 0, 12)
sliderBtn.Position = UDim2.new(0, -6, 0.5, -6)
sliderBtn.BackgroundColor3 = LAVENDER
sliderBtn.Text = ""
sliderBtn.Parent = sliderBar

local inputBox = Instance.new("TextBox")
inputBox.Size = UDim2.new(0, 100, 0, 30)
inputBox.Position = UDim2.new(0.5, -50, 0.5, -15)
inputBox.Text = "100"
inputBox.Visible = false
inputBox.Font = Enum.Font.Gotham
inputBox.TextSize = 14
inputBox.TextColor3 = LAVENDER
inputBox.BackgroundColor3 = DARK3
inputBox.Parent = valueFrame
Instance.new("UICorner", inputBox).CornerRadius = UDim.new(0,6)

-- Value Logic
local speedValue = 100
local dragging = false
sliderBtn.MouseButton1Down:Connect(function() dragging = true end)
uis.InputEnded:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then dragging=false end end)

rs.RenderStepped:Connect(function()
    if dragging then
        local mouseX = uis:GetMouseLocation().X
        local startX = sliderBar.AbsolutePosition.X
        local sizeX = sliderBar.AbsoluteSize.X
        local percent = math.clamp((mouseX-startX)/sizeX,0,1)
        sliderFill.Size = UDim2.new(percent,0,1,0)
        sliderBtn.Position = UDim2.new(percent, -6, 0.5, -6)
        speedValue = math.floor(percent*20000)
        inputBox.Text = tostring(speedValue)
    end
end)

inputBox.FocusLost:Connect(function()
    local n = tonumber(inputBox.Text)
    if n then
        speedValue = math.clamp(n,0,150000)
        local percent = math.clamp(speedValue,0,20000) / 20000
        sliderFill.Size = UDim2.new(percent,0,1,0)
        sliderBtn.Position = UDim2.new(percent, -6, 0.5, -6)
    else
        inputBox.Text = tostring(speedValue)
    end
end)

-- Input Type Toggle
rs.RenderStepped:Connect(function()
    local mode = getInputType()
    sliderBar.Visible = (mode=="Slider")
    sliderBtn.Visible = (mode=="Slider")
    sliderFill.Visible = (mode=="Slider")
    inputBox.Visible = (mode=="NumberBox")
end)

-- Minimize + Fullscreen
local minimized = false
local fullscreen = false

minBtn.MouseButton1Click:Connect(function()
    minimized = not minimized
    fullscreen = false
    if minimized then
        content.Visible=false
        mainFrame:TweenSize(UDim2.new(0,330,0,40), "Out","Quad",0.25,true)
        title.Text = "Speed GUI"
    else
        content.Visible=true
        mainFrame:TweenSize(UDim2.new(0,280,0,content.AbsoluteSize.Y+60), "Out","Quad",0.25,true)
        title.Text = "Speed GUI"
    end
end)

fullBtn.MouseButton1Click:Connect(function()
    if minimized then return end
    fullscreen = not fullscreen
    if fullscreen then
        mainFrame:TweenSize(UDim2.new(0.5,0,0.6,0), "Out","Quad",0.3,true)
    else
        mainFrame:TweenSize(UDim2.new(0,280,0,content.AbsoluteSize.Y+60), "Out","Quad",0.3,true)
    end
end)

--// Speed Application
local char,hum,hrp
local function updateChar()
    char = plr.Character or plr.CharacterAdded:Wait()
    hum = char:WaitForChild("Humanoid")
    hrp = char:WaitForChild("HumanoidRootPart")
end
updateChar()
plr.CharacterAdded:Connect(updateChar)

rs.Heartbeat:Connect(function()
    if not enabled or not hum or not hrp then return end
    local method = getMethod()

    if method=="WalkSpeed" then
        hum.WalkSpeed = speedValue
    elseif method=="CFrame" then
        if hum.MoveDirection.Magnitude>0 then
            hrp.CFrame = hrp.CFrame + (hum.MoveDirection*(speedValue/50))
        end
    elseif method=="BodyVelocity" then
        local bv = hrp:FindFirstChild("SpeedBV") or Instance.new("BodyVelocity")
        bv.Name="SpeedBV"
        bv.MaxForce=Vector3.new(1e5,0,1e5)
        bv.Velocity=hum.MoveDirection*speedValue
        bv.Parent=hrp
    elseif method=="HRP Velocity" then
        if hum.MoveDirection.Magnitude>0 then
            hrp.Velocity = hum.MoveDirection*speedValue
        end
    end
end)

--// Dragging System
local draggingGui, dragStart, startPos
topBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingGui = true
        dragStart = input.Position
        startPos = mainFrame.Position
    end
end)
topBar.InputChanged:Connect(function(input)
    if draggingGui and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end
end)
topBar.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingGui = false
    end
end)

-- // Instant Stop Feature
local instantStopEnabled = false
local instantStopKey = Enum.KeyCode.X -- default key

-- Button
local stopBtn = Instance.new("TextButton")
stopBtn.Size = UDim2.new(1, 0, 0, 35)
stopBtn.BackgroundColor3 = DARK3
stopBtn.Text = "Instant Stop: OFF"
stopBtn.Font = Enum.Font.GothamBold
stopBtn.TextSize = 16
stopBtn.TextColor3 = LAVENDER
stopBtn.Parent = content
Instance.new("UICorner", stopBtn).CornerRadius = UDim.new(0, 8)

-- Keybind label (smaller + shifted)
local keyLabel = Instance.new("TextButton")
keyLabel.Size = UDim2.new(0, 70, 0, 24) -- smaller size
keyLabel.Position = UDim2.new(1, -80, 0.5, -12) -- nudged right
keyLabel.AnchorPoint = Vector2.new(0,0)
keyLabel.BackgroundColor3 = DARK2
keyLabel.Text = "Key: X"
keyLabel.Font = Enum.Font.Gotham
keyLabel.TextSize = 13
keyLabel.TextColor3 = LAVENDER
keyLabel.Parent = stopBtn
Instance.new("UICorner", keyLabel).CornerRadius = UDim.new(0,6)

-- Toggle instant stop
stopBtn.MouseButton1Click:Connect(function()
    instantStopEnabled = not instantStopEnabled
    stopBtn.Text = "Instant Stop: " .. (instantStopEnabled and "ON" or "OFF")
    stopBtn.BackgroundColor3 = instantStopEnabled and LAVENDER or DARK3
    stopBtn.TextColor3 = instantStopEnabled and DARK1 or LAVENDER
end)

-- Change keybind
local waitingForKey = false
keyLabel.MouseButton1Click:Connect(function()
    keyLabel.Text = "Press Key..."
    waitingForKey = true
end)

uis.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if waitingForKey and input.UserInputType == Enum.UserInputType.Keyboard then
        instantStopKey = input.KeyCode
        keyLabel.Text = "Key: " .. input.KeyCode.Name
        waitingForKey = false
    elseif instantStopEnabled and input.KeyCode == instantStopKey then
        if hrp then
            hrp.Velocity = Vector3.zero
            hrp.RotVelocity = Vector3.zero
            local bv = hrp:FindFirstChild("SpeedBV")
            if bv then bv.Velocity = Vector3.zero end
        end
    end
end)
